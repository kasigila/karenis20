<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BYZ Tempo Booking</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    /* same CSS as booking.html */
    :root{
      --bg:#ffffff;
      --bg-alt:#f5f5f7;
      --bg-elev:#ffffff;
      --text:#1d1d1f;
      --sub:#6e6e73;
      --border:#d2d2d7;
      --accent:#000000;

      --radius: 22px;
      --radius-lg: 28px;
      --shadow: 0 18px 60px rgba(0,0,0,.08);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.08);
      --ease: cubic-bezier(.2,.8,.2,1);
      --max: 1100px;
      --header-h: 64px;

      --ok:#0a7f3f;
      --warn:#b45309;
      --whatsapp:#25D366;
    }
    [data-theme="dark"]{
      --bg:#000000;
      --bg-alt:#1c1c1e;
      --bg-elev:#0b0b0c;
      --text:#f5f5f7;
      --sub:#a1a1a6;
      --border:#2c2c2e;
      --accent:#ffffff;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --shadow-soft: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth; scroll-padding-top: calc(var(--header-h) + 24px);}
    body{
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Helvetica,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.55;
      transition: background .35s var(--ease), color .35s var(--ease);
      overflow-x:hidden;
      padding-top: calc(var(--header-h) + env(safe-area-inset-top));
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:var(--max);margin:0 auto;padding:0 24px}
@media (max-width: 560px){
  .container{ padding: 0 28px; }
}

    header{
      position:fixed;
      top:0;left:0;right:0;
      padding-top: env(safe-area-inset-top);
      height: calc(var(--header-h) + env(safe-area-inset-top));
      background: color-mix(in srgb, var(--bg) 86%, transparent);
      backdrop-filter: blur(18px);
      border-bottom:1px solid var(--border);
      z-index:999;
    }
    .header-inner{
      height:var(--header-h);
      display:flex;align-items:center;justify-content:space-between;
      gap:16px;
    }
    .brand{
      display:flex;align-items:center;gap:10px;
      font-weight:700;letter-spacing:-.4px;
    }
    .brand-logo-wrap{
      width:34px;height:34px;border-radius:12px;
      overflow:hidden;display:grid;place-items:center;
    }
    .brand-logo{width:100%;height:100%;object-fit:contain;display:block}
    .logo-dark{display:none;}
    [data-theme="dark"] .logo-light{display:none;}
    [data-theme="dark"] .logo-dark{display:block;}

    .top-actions{display:flex;align-items:center;gap:10px}
    .pill{
      display:inline-flex;align-items:center;gap:10px;
      padding:10px 14px;border-radius:999px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(12px);
      font-size:13px;
      color:var(--sub);
      transition: transform .2s var(--ease), box-shadow .2s var(--ease);
      box-shadow: var(--shadow-soft);
    }
    .pill:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
    .pill strong{color:var(--text);font-weight:700}
    .theme-btn{
      width:42px;height:42px;border-radius:16px;
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow-soft);
      display:grid;place-items:center;
      cursor:pointer;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease);
    }
    .theme-btn:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
    .theme-btn i{font-size:18px;color:var(--text)}
    main{padding-top: 28px;padding-bottom: 90px;}
    .hero{
      margin-top: 8px;
      border-radius: var(--radius-lg);
      border:1px solid var(--border);
      background: linear-gradient(
        180deg,
        color-mix(in srgb, var(--bg-alt) 85%, transparent),
        color-mix(in srgb, var(--bg) 92%, transparent)
      );
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .hero-inner{
      padding: 28px 22px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .hero h1{
      font-size: clamp(26px, 4vw, 40px);
      letter-spacing: -1px;
      line-height: 1.1;
    }
    .hero p{
      margin-top:10px;
      color:var(--sub);
      max-width: 60ch;
      font-size: 15px;
    }
    .hero-right{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
      min-width: 220px;
      flex: 1;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 14px;
      border-radius:999px;
      border:1px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow-soft);
      color:var(--sub);
      font-size:13px;
      white-space:nowrap;
    }
    .tag i{color:var(--text)}
    .progress{
      width: min(360px, 100%);
      border:1px solid var(--border);
      border-radius: 999px;
      background: var(--bg-elev);
      overflow:hidden;
      box-shadow: var(--shadow-soft);
    }
    .bar{height:10px;width:25%;background:var(--accent);transition: width .35s var(--ease);}
    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      margin-top:16px;
      align-items:start;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: 1fr;} }
    .card{
      border-radius: var(--radius-lg);
      border:1px solid var(--border);
      background: var(--bg-elev);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-head{padding:18px 18px 0;}
    .card-head h2{font-size:18px;letter-spacing:-.3px;}
    .card-head p{margin-top:6px;color:var(--sub);font-size:14px;}
    .card-body{padding:18px;}
    .choice-grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top: 12px;
    }
    @media (max-width: 640px){ .choice-grid{grid-template-columns:1fr;} }
    .choice{
      border-radius:20px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      box-shadow: var(--shadow-soft);
      padding:16px;
      cursor:pointer;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease), background .2s var(--ease);
      position:relative;overflow:hidden;
    }
    .choice:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
    .choice.active{
      outline: 2px solid color-mix(in srgb, var(--accent) 65%, transparent);
      background: color-mix(in srgb, var(--bg-alt) 70%, transparent);
    }
    .choice .row{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .choice h3{font-size:16px;letter-spacing:-.3px}
    .choice p{margin-top:6px;color:var(--sub);font-size:13px}
    .choice .icon{
      width:40px;height:40px;border-radius:14px;border:1px solid var(--border);
      display:grid;place-items:center;background: var(--bg-elev);box-shadow: var(--shadow-soft);
      flex:0 0 auto;
    }
    .choice .icon i{color:var(--text)}
    .step{display:none}
    .step.active{display:block}
    .selector{
      margin-top: 12px;border-radius: 22px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      padding:16px;box-shadow: var(--shadow-soft);
    }
    .selector .controls{
      display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px;
    }
    select{
      padding:12px 14px;border-radius:16px;border:1px solid var(--border);
      background: var(--bg-elev);color: var(--text);font-size:14px;outline:none;
    }
    .btn{
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 16px;border-radius:999px;border:1px solid var(--border);
      background: var(--bg-elev);color: var(--text);font-weight:700;cursor:pointer;
      transition: transform .2s var(--ease), box-shadow .2s var(--ease);
      box-shadow: var(--shadow-soft);user-select:none;
    }
    .btn:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
    .btn.primary{background: var(--accent);color: var(--bg);border-color: transparent;}
    .btn.submitted{
  background:#0a7f3f;
  color:#fff;
  border-color: transparent;
}

    .btn.ghost{background: color-mix(in srgb, var(--bg) 88%, transparent);backdrop-filter: blur(12px);}
    .price-display{
      margin-left:auto;padding:10px 14px;border-radius:999px;border:1px solid var(--border);
      background: var(--bg-elev);color: var(--text);font-weight: 800;letter-spacing: -.3px;
      box-shadow: var(--shadow-soft);white-space:nowrap;
    }
    .packages{
      margin-top: 12px;display:grid;grid-template-columns: repeat(3, 1fr);gap:12px;
    }
    @media (max-width: 900px){ .packages{grid-template-columns:1fr;} }
    .package{
      border-radius:22px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      box-shadow: var(--shadow-soft);
      padding:16px;cursor:pointer;transition: transform .2s var(--ease), box-shadow .2s var(--ease), background .2s var(--ease);
      position:relative;overflow:hidden;min-height:160px;
    }
    .package:hover{transform: translateY(-2px); box-shadow: var(--shadow);}
    .package.active{
      outline: 2px solid color-mix(in srgb, var(--accent) 65%, transparent);
      background: color-mix(in srgb, var(--bg-alt) 70%, transparent);
    }
    .package.sold{opacity:.55;cursor:not-allowed;filter: grayscale(.2);}
    .package .badge{
      position:absolute; top:14px; right:14px;
      padding:7px 10px;border-radius:999px;border:1px solid var(--border);
      background: var(--bg-elev);font-size:12px;color:var(--sub);box-shadow: var(--shadow-soft);
    }
    .package h3{font-size:15px;letter-spacing:-.2px}
    .package .big{font-size:26px;font-weight:900;letter-spacing:-1px;margin-top:10px;}
    .package ul{margin-top:10px;display:flex;flex-direction:column;gap:6px;list-style:none}
    .package li{font-size:13px;color:var(--sub)}
    .package li i{margin-right:8px;color:var(--text)}
    .paybox{
      margin-top:12px;border-radius: var(--radius-lg);border:1px solid var(--border);
      background: linear-gradient(180deg, color-mix(in srgb, var(--bg-alt) 80%, transparent), color-mix(in srgb, var(--bg) 92%, transparent));
      box-shadow: var(--shadow);padding: 18px;
    }
    .paygrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
    .paycard{
      border-radius:22px;border:1px solid var(--border);
      background: var(--bg-elev);box-shadow: var(--shadow-soft);padding:16px;
    }
    .muted{color:var(--sub);font-size:13px}
    .mpesa-number{
      font-size: clamp(24px, 6vw, 34px);
      letter-spacing: .14em;
      font-weight: 900;
      margin-top: 6px;
      word-break: break-word;
    }
    .whatsapp-hint{
      margin-top:10px;display:flex;gap:10px;align-items:flex-start;
      padding:12px 14px;border-radius:18px;border:1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 88%, transparent);
      box-shadow: var(--shadow-soft);color:var(--sub);font-size:13px;
    }
    .whatsapp-dot{width:10px;height:10px;border-radius:999px;background: var(--whatsapp);margin-top:4px;flex:0 0 auto;}
    .form{margin-top:12px;display:flex;flex-direction:column;gap:10px;}
    input{
      width:100%;padding:14px;border-radius:18px;border:1px solid var(--border);
      background: var(--bg-elev);color: var(--text);outline:none;font-size:14px;
      transition: box-shadow .2s var(--ease), transform .2s var(--ease);
      box-shadow: var(--shadow-soft);
    }
    input:focus{
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--accent) 20%, transparent), var(--shadow-soft);
    }
    .notice{margin-top:6px;color:var(--sub);font-size:13px}
    .foot{margin-top:16px;color:var(--sub);font-size:12px;text-align:center;}
    @media (max-width: 520px){
      .hero-inner{padding: 22px 16px}
      .card-head{padding: 16px 16px 0}
      .card-body{padding: 16px}
    }

    .toast{
      position: fixed;left: 50%;bottom: 22px;
      transform: translateX(-50%) translateY(18px);
      opacity: 0;pointer-events: none;z-index: 9999;
      transition: opacity .25s var(--ease), transform .25s var(--ease);
      width: min(520px, calc(100% - 24px));
    }
    .toast.show{opacity:1;transform: translateX(-50%) translateY(0);pointer-events:auto;}
    .toast-card{
      border-radius: 22px;border: 1px solid var(--border);
      background: color-mix(in srgb, var(--bg) 92%, transparent);
      backdrop-filter: blur(14px);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      display: flex;gap: 12px;align-items: flex-start;
    }
    .toast-body{flex: 1;color: var(--text);font-size: 14px;line-height: 1.35;}
    .toast-sub{margin-top: 6px;color: var(--sub);font-size: 13px;}
    .toast-actions{margin-top: 10px;display: flex;gap: 10px;flex-wrap: wrap;}
    .toast-link{
      display: inline-flex;align-items: center;justify-content: center;gap: 10px;
      padding: 10px 12px;border-radius: 999px;border: 1px solid var(--border);
      background: var(--bg-elev);color: var(--text);font-weight: 800;text-decoration: none;
      box-shadow: var(--shadow-soft);
    }
    .toast-close{
      width: 36px;height: 36px;border-radius: 16px;border: 1px solid var(--border);
      background: var(--bg-elev);box-shadow: var(--shadow-soft);cursor: pointer;
      display: grid;place-items: center;flex: 0 0 auto;
    }
    .toast-close i{ font-size: 14px; }
  </style>
</head>

<body data-theme="light">
  <header>
    <div class="container header-inner">
      <a class="brand" href="./index.html" aria-label="BYZ Home">
        <span class="brand-logo-wrap" aria-hidden="true">
          <img class="brand-logo logo-light" src="assets/byz-logo-black.png" alt="" />
          <img class="brand-logo logo-dark"  src="assets/byz-logo-white.png" alt="" />
        </span>
      </a>

      <div class="top-actions">
        <a class="pill" href="./index.html">
          <i class="fa-solid fa-arrow-left"></i>
          <span>Back to <strong>Home</strong></span>
        </a>
        <button class="theme-btn" onclick="toggleTheme()" aria-label="Toggle theme" title="Toggle theme">
          <i class="fa-solid fa-circle-half-stroke"></i>
        </button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div class="hero-inner">
        <div>
          <h1>Book your Tempo experience</h1>
          <p>
            Choose tickets or a VIP table, complete M-Pesa payment, then submit your details.
            WhatsApp will open for verification... just press <b>SEND</b>.
          </p>
        </div>

        <div class="hero-right">
          <div class="tag"><i class="fa-solid fa-shield-halved"></i> Secure checkout flow</div>
          <div class="progress" aria-label="Progress">
            <div class="bar" id="progressBar"></div>
          </div>
          <div class="tag"><i class="fa-solid fa-location-dot"></i> Dar es Salaam</div>
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="card">
        <div class="card-head">
          <h2>1) Choose booking type</h2>
          <p>Tickets for individuals & VIP tables for groups.</p>
        </div>

        <div class="card-body">
          <div class="choice-grid">
            <div class="choice" onclick="selectType('TICKET', this)" role="button" tabindex="0">
              <div class="row">
                <div>
                  <h3>Tickets</h3>
                  <p>Fast entry. Simple checkout.</p>
                </div>
                <div class="icon"><i class="fa-solid fa-ticket"></i></div>
              </div>
            </div>

            <div class="choice" onclick="selectType('TABLE', this)" role="button" tabindex="0">
              <div class="row">
                <div>
                  <h3>VIP Table</h3>
                  <p>Reserved seating + premium service.</p>
                </div>
                <div class="icon"><i class="fa-solid fa-champagne-glasses"></i></div>
              </div>
            </div>
          </div>

          <div class="step" id="ticketStep">
            <div class="selector">
              <h3 style="letter-spacing:-.3px;">Select number of tickets</h3>
              <div class="controls">
                <button class="btn ghost" type="button" onclick="stepTicket(-1)"><i class="fa-solid fa-minus"></i></button>
                <select id="ticketQty" onchange="updateTicketPrice()">
                  <option value="1">1 Ticket</option>
                  <option value="2">2 Tickets</option>
                  <option value="3">3 Tickets</option>
                  <option value="4">4 Tickets</option>
                  <option value="5">5 Tickets</option>
                  <option value="6">6 Tickets</option>
                  <option value="7">7 Tickets</option>
                  <option value="8">8 Tickets</option>
                  <option value="9">9 Tickets</option>
                  <option value="10">10 Tickets</option>
                </select>
                <button class="btn ghost" type="button" onclick="stepTicket(1)"><i class="fa-solid fa-plus"></i></button>
                <div class="price-display" id="ticketTotal">30,000 TZS</div>
              </div>
            </div>
          </div>

          <div class="step" id="tablesStep">
            <h3 style="letter-spacing:-.3px;margin-top:14px;">Choose your VIP package</h3>
            <p class="muted">Each tier has limited availability.</p>
            <div class="packages" id="packages"></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="card-head">
          <h2>2) Pay + submit details</h2>
          <p>Complete M-Pesa first, then paste Transaction ID.</p>
        </div>

        <div class="card-body">
          <div class="step" id="paymentStep">
            <div class="paybox">
              <div class="paygrid">
                <div class="paycard">
                  <div class="muted">Business name</div>
                  <div style="font-weight:800;letter-spacing:-.3px;margin-top:4px;">BYZ Entertainment</div>

                  <div style="height:10px"></div>

                  <div class="muted">M-Pesa Lipa Number</div>
                  <div class="mpesa-number" id="mpesaNumber">68286833</div>

                  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:12px;">
                    <button class="btn primary" onclick="copyMpesa()" type="button">
                      <i class="fa-regular fa-copy"></i>
                      Copy Lipa Number
                    </button>

                    <a class="btn" href="tel:*150*00#" style="text-decoration:none">
                      <i class="fa-solid fa-phone"></i>
                      Open M-Pesa
                    </a>
                  </div>

                  <div class="whatsapp-hint">
                    <div class="whatsapp-dot"></div>
                    <div>
                      After submitting, WhatsApp opens automatically for payment verification.
                      Press <b>SEND</b>.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="step" id="formStep">
            <div class="form">
              <input id="fullName" placeholder="Full Name" autocomplete="name">
              <input id="phone" placeholder="Phone (WhatsApp)" autocomplete="tel">
              <input id="email" placeholder="Email" autocomplete="email">
              <input id="txn" placeholder="M-Pesa Transaction ID">

              <button class="btn primary" id="submitBookingBtn" onclick="submitBooking()" type="button">
                <i class="fa-solid fa-lock"></i>
                Submit Booking
              </button>

              <div class="notice">WhatsApp will open — press <b>SEND</b> to verify payment.</div>
            </div>

            <div class="foot"> </div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxl8qg5fxw8yWZJj-R98x0V0nBALjQv66xuJLiom5rkEh_BpYtZRrMcFlYkjxAOq6UC/exec";
    const BYZ_WHATSAPP = "255768464367";
    const TICKET_PRICE = 30000;
    const EVENT_KEY = "tempo";

    let bookingType="", tier="", ticketQty=1, availability=[];

    (function initTheme(){
      const saved = localStorage.getItem("byz_theme");
      if(saved === "dark"){ document.body.setAttribute("data-theme","dark"); }
    })();

    function toggleTheme(){
      const isDark = document.body.getAttribute("data-theme") === "dark";
      document.body.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("byz_theme", isDark ? "light" : "dark");
    }

    function setProgress(pct){
      const bar = document.getElementById("progressBar");
      bar.style.width = pct + "%";
    }
    setProgress(25);

    function copyMpesa(){
      const number = document.getElementById("mpesaNumber").innerText.trim();
      if (navigator.clipboard) {
        navigator.clipboard.writeText(number);
      } else {
        const temp = document.createElement("textarea");
        temp.value = number;
        document.body.appendChild(temp);
        temp.select();
        document.execCommand("copy");
        document.body.removeChild(temp);
      }
      alert("Lipa number copied. Open M-Pesa to complete payment.");
    }

    function selectType(type, el){
      bookingType = type;
      document.querySelectorAll(".choice").forEach(c => c.classList.remove("active"));
      el.classList.add("active");

      document.getElementById("ticketStep").classList.remove("active");
      document.getElementById("tablesStep").classList.remove("active");

      if(type === "TICKET"){
        document.getElementById("ticketStep").classList.add("active");
      } else {
        document.getElementById("tablesStep").classList.add("active");
      }

      document.getElementById("paymentStep").classList.add("active");
      document.getElementById("formStep").classList.add("active");

      setProgress(66);
    }

    function updateTicketPrice(){
      const qtyEl = document.getElementById("ticketQty");
      ticketQty = Number(qtyEl.value || 1);
      document.getElementById("ticketTotal").textContent =
        (ticketQty * TICKET_PRICE).toLocaleString() + " TZS";
    }

    function stepTicket(delta){
      const qtyEl = document.getElementById("ticketQty");
      const current = Number(qtyEl.value || 1);
      const next = Math.min(10, Math.max(1, current + delta));
      qtyEl.value = String(next);
      updateTicketPrice();
    }
    updateTicketPrice();

    function safeArrayBookings(d){
      if(d && Array.isArray(d.bookings)) return d.bookings;
      return [];
    }

    fetch(SCRIPT_URL + "?event=" + EVENT_KEY)
      .then(r => r.json())
      .then(d => {
        availability = safeArrayBookings(d);
        renderTables();
      })
      .catch(() => {
        availability = [];
        renderTables();
      });

    function renderTables(){
      const tiers = [
        {id:"700K", label:"Umlando", price:700000, features:["2 × Cognac VS","Mixers/Chasers","Shisha","10 Pax (People)"]},
        {id:"1.2M", label:"Yebo", price:1200000, features:["3 × Cognac VS","Mixers/Chasers","2 × Shisha","15 Pax (People)"]},
        {id:"1.8M", label:"Adiwele", price:1800000, features:["4 × Cognac VS","Mixers/Chasers","2 × Shisha","20 Pax (People)"]}
      ];

      const container = document.getElementById("packages");
      container.innerHTML = "";

      tiers.forEach(t => {
        const used = availability.filter(b => b.tier === t.id && b.status === "CONFIRMED").length;
        const sold = used >= 4;

        const div = document.createElement("div");
        div.className = "package" + (sold ? " sold" : "");
        div.setAttribute("role","button");
        div.setAttribute("tabindex","0");

        div.innerHTML = `
          <div class="badge">${sold ? "Sold out" : (4-used) + " left"}</div>
          <h3>${t.label}</h3>
          <div class="big">${t.price.toLocaleString()} TZS</div>
          <ul>
            ${t.features.map(f => `<li><i class="fa-solid fa-check"></i>${f}</li>`).join("")}
          </ul>
        `;

        div.onclick = () => {
          if(sold) return;
          tier = t.id;
          document.querySelectorAll(".package").forEach(p => p.classList.remove("active"));
          div.classList.add("active");
        };

        div.onkeydown = (e) => {
          if(e.key !== "Enter") return;
          div.click();
        };

        container.appendChild(div);
      });
    }

    function getOrderQuantity(){
      if(bookingType === "TICKET") return ticketQty;
      if(tier === "700K") return 10;
      if(tier === "1.2M") return 15;
      if(tier === "1.8M") return 20;
      return 1;
    }

    let __submittingBooking = false;

    async function submitBooking(){
      if(__submittingBooking) return;
      __submittingBooking = true;

      const btn = document.querySelector('button.btn.primary[onclick="submitBooking()"]');
      const btnText = btn ? btn.innerHTML : "";
      if(btn){
        btn.disabled = true;
        btn.style.opacity = "0.7";
        btn.style.pointerEvents = "none";
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i> Sending...`;
      }

      let amount = 0, desc = "";

      if(bookingType === "TICKET"){
        amount = ticketQty * TICKET_PRICE;
        desc = `Tempo • ${ticketQty} Ticket(s)`;
      } else {
        if(!tier){
          if(btn){
            btn.disabled = false;
            btn.style.opacity = "";
            btn.style.pointerEvents = "";
            btn.innerHTML = btnText;
          }
          __submittingBooking = false;
          return alert("Select a VIP table");
        }
        amount = tier === "700K" ? 700000 : tier === "1.2M" ? 1200000 : 1800000;
        desc = `Tempo • VIP Table ${tier}`;
      }

      const quantity = getOrderQuantity();

      const data = {
        eventKey: EVENT_KEY,
        bookingType,
        tier,
        description: desc,
        quantity,
        checkedInCount: 0,
        amount,
        name: fullName.value,
        phone: phone.value,
        email: email.value,
        transactionCode: txn.value,
        requestId: (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + "-" + Math.random().toString(16).slice(2))
      };

      if(!data.name || !data.phone || !data.transactionCode){
        if(btn){
          btn.disabled = false;
          btn.style.opacity = "";
          btn.style.pointerEvents = "";
          btn.innerHTML = btnText;
        }
        __submittingBooking = false;
        return alert("Please enter Name, Phone, and Transaction ID.");
      }

      try{
        const res = await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify({ action: "addBooking", data }),
          keepalive: true
        }).then(r => r.json());

        await new Promise(r => setTimeout(r, 700));

        const bookingId = res && res.bookingId ? res.bookingId : "(pending)";

        const msg =
`NEW BYZ BOOKING (TEMPO)
BookingID: ${bookingId}
Name: ${data.name}
Phone: ${data.phone}
${desc}
Qty: ${quantity}
Amount: ${amount}
Txn: ${data.transactionCode}`;

        const waUrl = `https://wa.me/${BYZ_WHATSAPP}?text=${encodeURIComponent(msg)}`;

        sessionStorage.setItem("byz_last_wa", waUrl);
        sessionStorage.setItem("byz_last_ts", String(Date.now()));
        sessionStorage.setItem("byz_last_bookingId", bookingId);
        sessionStorage.setItem("byz_last_status", "submitted");

        setProgress(100);
showPendingToast();
setTimeout(() => {
  window.location.href = waUrl;
}, 650);



      }catch(err){
        console.error(err);
        alert("Booking failed. Please try again.");

        if(btn){
          btn.disabled = false;
          btn.style.opacity = "";
          btn.style.pointerEvents = "";
          btn.innerHTML = btnText;
        }
        __submittingBooking = false;
      }
    }

let __toastTimer = null;
function ensureToast(){
  if(document.getElementById("byzToast")) return;

  const wrap = document.createElement("div");
  wrap.id = "byzToast";
  wrap.className = "toast";
  wrap.innerHTML = `
    <div class="toast-card" role="dialog" aria-modal="true">
      <button class="toast-close" type="button" aria-label="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div class="toast-body" id="byzToastBody"></div>
    </div>
  `;

  document.body.appendChild(wrap);

  wrap.querySelector(".toast-close").addEventListener("click", closeBookingModal);
  wrap.addEventListener("click", (e) => {
    if(e.target === wrap) closeBookingModal();
  });
}
function closeBookingModal(){
  const toast = document.getElementById("byzToast");
  if(toast) toast.classList.remove("show");
  document.body.style.overflow = "";
  markSubmitted();
  __submittingBooking = false;
  sessionStorage.setItem("byz_last_status","done");
}

function showToast(html){
  ensureToast();
  const toast = document.getElementById("byzToast");
  const body = document.getElementById("byzToastBody");

  body.innerHTML = html;
  toast.classList.add("show");
  document.body.style.overflow = "hidden";
}

    function markSubmitted(){
  const btn = document.getElementById("submitBookingBtn");
  if(!btn) return;
  btn.classList.add("submitted");
  btn.innerHTML = `<i class="fa-solid fa-circle-check"></i> Booking submitted`;
}

function showPendingToast(){
  showToast(
    `<div><b>Booking submitted!</b></div>
     <div class="toast-sub">Pending verification. You’ll get a confirmation email once approved.</div>`
  );
}


function resetSubmitUI(){
  __submittingBooking = false;
  const btn = document.getElementById("submitBookingBtn");
  if(btn){
    btn.disabled = false;
    btn.style.opacity = "";
    btn.style.pointerEvents = "";
    btn.innerHTML = `<i class="fa-solid fa-lock"></i> Submit Booking`;
  }
}
function showBookingSubmittedUI(){
  const bookingId = sessionStorage.getItem("byz_last_bookingId") || "";
  const wa = sessionStorage.getItem("byz_last_wa") || "";
  const notice = document.querySelector("#formStep .notice");
  if(notice){
    notice.innerHTML = `Booking submitted ✅ WhatsApp opened — press <b>SEND</b> to verify payment.`;
  }
  const foot = document.querySelector(".foot");
  if(foot){ foot.innerHTML = ""; }
  const toastHtml = `
    <div><b>Booking submitted ✅</b></div>
    ${bookingId ? `<div class="toast-sub">Booking ID: <b>${bookingId}</b></div>` : ``}
    <div class="toast-actions">
      ${wa ? `<a class="toast-link" href="${wa}" target="_blank" rel="noopener"><i class="fa-brands fa-whatsapp"></i> Open WhatsApp again</a>` : ``}
    </div>
  `;
  showToast(toastHtml, 9000);
  setProgress(100);
}
function handleReturnFromWhatsApp(){
  const status = sessionStorage.getItem("byz_last_status");
  const ts = Number(sessionStorage.getItem("byz_last_ts") || "0");

  if(status === "submitted" && (Date.now() - ts < 10 * 60 * 1000)){
    showPendingToast();
  }
}

window.addEventListener("pageshow", handleReturnFromWhatsApp);
window.addEventListener("focus", handleReturnFromWhatsApp);
document.addEventListener("visibilitychange", () => {
  if(!document.hidden) handleReturnFromWhatsApp();
});
  </script>
</body>
</html>
